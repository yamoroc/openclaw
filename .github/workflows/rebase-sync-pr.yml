name: Rebase Sync PR (fork custom-main <- upstream/main)

on:
  schedule:
    - cron: "20 2 * * *" # daily UTC; adjust as needed
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: rebase-sync-${{ github.repository }}
  cancel-in-progress: false

env:
  # Official repository (upstream)
  UPSTREAM_REPO: https://github.com/OpenClaw/OpenClaw.git
  # Fork target branch that carries local customizations
  TARGET_BRANCH: custom-main

jobs:
  rebase-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Prefer PAT (with workflow permission) when available,
          # fallback to GITHUB_TOKEN for normal repos.
          token: ${{ secrets.WORKFLOW_PUSH_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup git identity + rerere
        run: |
          git config user.name "rebase-bot"
          git config user.email "rebase-bot@users.noreply.github.com"
          git config rerere.enabled true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Add upstream remote and fetch all
        run: |
          git remote add upstream "${UPSTREAM_REPO}" || true
          git fetch --prune origin
          git fetch --prune upstream

      - name: Preflight checks
        run: |
          set -euo pipefail

          git show-ref --verify --quiet "refs/remotes/origin/${TARGET_BRANCH}" || {
            echo "ERROR: origin/${TARGET_BRANCH} not found. Create branch first.";
            exit 1;
          }

          git show-ref --verify --quiet "refs/remotes/upstream/main" || {
            echo "ERROR: upstream/main not found.";
            exit 1;
          }

          echo "=== upstream/main ==="
          git rev-parse upstream/main
          echo "=== origin/${TARGET_BRANCH} ==="
          git rev-parse "origin/${TARGET_BRANCH}"

          echo "=== Diff overview (left=upstream, right=fork target) ==="
          git log --oneline --left-right --cherry-pick --no-merges \
            "upstream/main...origin/${TARGET_BRANCH}" | head -n 120 || true

      - name: Create temp branch and rebase
        id: rebase
        run: |
          set -euo pipefail
          BRANCH="auto/rebase-sync-$(date +%Y%m%d)-${GITHUB_RUN_ID}"
          echo "branch_name=${BRANCH}" >> "$GITHUB_OUTPUT"

          git checkout -B "${TARGET_BRANCH}" "origin/${TARGET_BRANCH}"
          git checkout -B "${BRANCH}"

          # Rebase-only policy (no merge)
          git rebase upstream/main

          if git diff --quiet "origin/${TARGET_BRANCH}...HEAD"; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.rebase.outputs.has_changes == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build smoke check
        if: steps.rebase.outputs.has_changes == 'true'
        run: pnpm -s build

      - name: Optional test smoke check
        if: steps.rebase.outputs.has_changes == 'true'
        run: |
          if pnpm -s run | grep -q "test:smoke"; then
            pnpm -s test:smoke
          else
            echo "No test:smoke script; skipping."
          fi

      - name: Push temp branch (safe)
        if: steps.rebase.outputs.has_changes == 'true'
        run: |
          set -euo pipefail
          # Safety rule: NEVER push target branch directly from automation
          git push --force-with-lease origin "${{ steps.rebase.outputs.branch_name }}"

      - name: Wait for temp branch visibility
        if: steps.rebase.outputs.has_changes == 'true'
        run: |
          set -euo pipefail
          BRANCH="${{ steps.rebase.outputs.branch_name }}"
          for i in {1..12}; do
            if git ls-remote --exit-code origin "refs/heads/${BRANCH}" >/dev/null 2>&1; then
              echo "Branch ${BRANCH} is visible on origin."
              exit 0
            fi
            echo "Branch ${BRANCH} not visible yet (${i}/12); retry in 5s..."
            sleep 5
          done
          echo "ERROR: branch ${BRANCH} was not visible on origin after retries."
          exit 1

      - name: Close stale rebase-sync PRs
        if: steps.rebase.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN || secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          # Close any existing open rebase-sync PRs before creating a new one
          OPEN_PRS=$(gh pr list \
            --repo "$GH_REPO" \
            --state open \
            --base "${TARGET_BRANCH}" \
            --search "chore(sync): rebase" \
            --json number,headRefName \
            -q '.[] | "\(.number) \(.headRefName)"')

          if [ -n "$OPEN_PRS" ]; then
            echo "$OPEN_PRS" | while read -r pr_num branch_name; do
              echo "Closing stale PR #${pr_num} (branch: ${branch_name})..."
              gh pr close "$pr_num" --repo "$GH_REPO" --delete-branch \
                --comment "Auto-closed: superseded by newer rebase-sync run." || true
            done
          else
            echo "No stale rebase-sync PRs to close."
          fi

      - name: Create or update PR
        if: steps.rebase.outputs.has_changes == 'true'
        env:
          # Keep token consistent with checkout/push auth path.
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN || secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          HEAD_BRANCH="${{ steps.rebase.outputs.branch_name }}"
          BASE_BRANCH="${TARGET_BRANCH}"

          PR_NUMBER=$(gh pr list \
            --repo "$GH_REPO" \
            --state open \
            --base "$BASE_BRANCH" \
            --head "$HEAD_BRANCH" \
            --json number \
            -q '.[0].number')

          BODY_FILE=$(mktemp)
          {
            echo "Automated rebase sync PR."
            echo
            echo "Policy enforced:"
            # shellcheck disable=SC2016
            echo '- Rebase-only from `upstream/main`'
            echo "- No direct force-push to target branch"
            echo "- Temp branch push only"
            echo "- Build smoke checks completed before PR creation"
            echo
            echo "If conflicts or failed checks happen, automation stops and requires human intervention."
          } > "$BODY_FILE"

          if [ -n "${PR_NUMBER}" ] && [ "${PR_NUMBER}" != "null" ]; then
            gh pr edit "$PR_NUMBER" \
              --repo "$GH_REPO" \
              --title "chore(sync): rebase ${BASE_BRANCH} onto upstream/main ($(date +%F))" \
              --body-file "$BODY_FILE"
          else
            # GitHub can lag right after branch push; retry PR creation briefly.
            for i in {1..6}; do
              if gh pr create \
                --repo "$GH_REPO" \
                --base "$BASE_BRANCH" \
                --head "$HEAD_BRANCH" \
                --title "chore(sync): rebase ${BASE_BRANCH} onto upstream/main ($(date +%F))" \
                --body-file "$BODY_FILE"; then
                exit 0
              fi
              if [ "$i" -lt 6 ]; then
                echo "gh pr create failed (${i}/6); retry in 5s..."
                sleep 5
              fi
            done
            echo "ERROR: failed to create PR after retries."
            exit 1
          fi

      - name: No-op (already up to date)
        if: steps.rebase.outputs.has_changes != 'true'
        run: echo "No upstream changes requiring sync."
# Forcing re-parse
